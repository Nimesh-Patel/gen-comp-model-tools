---
title: "Basic SIR Models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{basic-sir}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(compModels)
```


## Deterministic Models
### Basic Deterministic SIR
The [compModels::run_sir()] function allows users to run a basic deterministic
susceptible-infected-recovered (SIR) compartmental model. The user specifies
the initial values for each of the states (s, i, r), a vector of times to
run the model over, and values for the transmission rate parameter beta and
recovery rate parameter gamma. It will return a data frame with one column for
time and a column for each state (compartment). This function makes use of
[compModels::sir_deriv()] and [compModels::validate_sir_input()] functions also
in the compModels package for the basic SIR model equations and for validating
the user-provided inputs to check they are of the correct type and within
plausible bounds. Output from run_sir() can be fed into
[compModels::plot_determin_model()] to view a plot of the output using ggplot2.

```{r deterministic}
modelout0 <- run_sir(
  init = c(s = 1e05 - 1, i = 1, r = 0),
  time = seq(0.1, 100, by = 0.1),
  parms = c(beta = 0.5, gamma = 0.1)
)
```

An alternative way to run this would be to use a configuration (config) file
to bring in the parameters instead of hard coding them. The file
config-basic.yml is also in the vignettes directory of this package and
contains the needed data for this.
```{r deterministic2}
config <- yaml::read_yaml("config-basic.yml") # passes package check()
# full path: compModels/vignettes/config-basic.yml

modelout <- run_sir(
  init = unlist(config$deterministic$init),
  time = seq(config$deterministic$time$start,
    config$deterministic$time$end,
    by = config$deterministic$time$by
  ),
  parms = c(
    beta = config$deterministic$parms$beta,
    gamma = config$deterministic$parms$gamma
  )
)
```


```{r deterministic plot, fig.dim = c(6,4)}
plot_determin_model(modelout0)
plot_determin_model(modelout)
```

### Deterministic SIR with Single Intervention
The [compModels::run_sir_intervention()] function allows users to run a basic
deterministic susceptible-infected-recovered (SIR) compartmental model with a
single intervention. As with [compModels::run_sir()], the user specifies
the initial values for each of the states (s, i, r), a vector of times to
run the model over, and values for the transmission rate parameter beta and
recovery rate parameter gamma. Additionally, the user can specify the start and
end time step for the intervention and how much impact it will have on
transmission. This function will return a data frame with one column for
time and a column for each state (compartment). This function makes use of
[compModels::sir_deriv_intervention()] and [compModels::validate_sir_input()]
functions also in the compModels package for the basic SIR model with
intervention equations and for validating the user-provided inputs to check
they are of the correct type and within plausible bounds. Output from
run_sir_intervention() can be fed into [compModels::plot_determin_model()] to
 view a plot of the output and intervention period using ggplot2.

```{r determin int}
# nolint start
# Hard coded
# modelout2 <- run_sir_intervention(
#   init = c(s = 1e05 - 1, i = 1, r = 0),
#   time = seq(0.1, 100, by = 0.1),
#   parms = list(
#     beta = 0.5, gamma = 0.1,
#     intervention_start_time = 20,
#     intervention_end_time = 30,
#     intervention_impact = 0.3
#   )
# )
# nolint end

# Using config file
modelout2 <- run_sir_intervention(
  init = unlist(config$deterministic$init),
  time = seq(config$deterministic$time$start,
    config$deterministic$time$end,
    by = config$deterministic$time$by
  ),
  parms = c(
    beta = config$deterministic$parms$beta,
    gamma = config$deterministic$parms$gamma,
    intervention_start_time = config$deterministic$intervention_start_time,
    intervention_end_time = config$deterministic$intervention_end_time,
    intervention_impact = config$deterministic$intervention_impact
  )
)
```

```{r deterministic int plot, fig.dim = c(6,4)}
# nolint start
# plot_determin_model(modelout2[, -5],
#   show_intervention_period = TRUE,
#   intervention_period = c(20, 30)
# )
# nolint end

plot_determin_model(modelout2[, -5],
  show_intervention_period = TRUE,
  intervention_period = c(
    config$intervention_start_time,
    config$intervention_end_time
  )
)
```


## Stochastic Models
### Basic Stochastic SIR - Gillespie Algorithm
The [compModels::run_sir_stochastic()] function allows users to run a basic
stochastic susceptible-infected-recovered (SIR) compartmental model using the
Gillespie Algorithm in [GillespieSSA::ssa.d]. The user specifies values for the
transmission rate parameter beta and recovery rate parameter gamma, initial
values for each of the states (s, i, r) and total population (n), the number of
timesteps, propensity functions that include the equations for the flows
between compartments, and a change matrix of the transition information between
compartments, and the number of simulations to run. It will return a data frame
with one column for time and a column for each state (compartment).
This function makes use of [compModels::validate_sir_stoch_input()] for
validating the user-provided inputs to check they are of the correct type and
within plausible bounds. Output from run_sir_stochastic() can be fed into
[compModels::plot_stoch_model()] to view a plot of one or more realizations of
the output using ggplot2.

```{r stochastic gillespie}
# nolint start
# modelout3 <- run_sir_stochastic(
#   0.001, 0.1, 499, 100, 0, 500, # parameters, initial values
#   100, # number of timesteps
#   c("beta*s*i", "gamma*i"), # propensity functions
#   matrix(c(-1, 0, +1, -1, 0, +1), # change matrix
#     nrow = 3, byrow = TRUE
#   ), 10 # number of simulations
# )
# nolint end

modelout3 <- run_sir_stochastic(
  # parameters, initial values
  config$stochastic$beta, config$stochastic$gamma,
  config$stochastic$s0, config$stochastic$i0, config$stochastic$r0,
  config$stochastic$n_pop, # population size
  config$stochastic$n_timesteps, # number of timesteps
  config$stochastic$propensity_fns, # propensity functions
  matrix(unlist(config$stochastic$change_matrix),
    nrow = length(config$stochastic$change_matrix),
    byrow = TRUE
  ), # change matrix
  config$stochastic$n_sims # number of simulations
)
```

```{r stochastic gillespie plot, fig.dim = c(6,4)}
# Plot will default to plotting "i" compartment as second argument to the
# function. Additionally, default time_var is "t" so if output variable is
# 'time', this will need to be specified. GillespieSSA returns t. NB: will need
#  to rename to plot other compartments or for models with other names for the
# infected compartment (eg. i1, i2, etc).
plot_stoch_model(modelout3)
```

### Basic Stochastic SIR - Adaptive Tau Leaping Algorithm
The [compModels::run_sir_stochastic_tau()] function allows users to run a basic
stochastic susceptible-infected-recovered (SIR) compartmental model using
adaptive tau leaping in [adaptivetau::ssa.exact()]. The user specifies values
for the transmission rate parameter beta and recovery rate parameter gamma,
initial values for each of the states (s, i, r) and total population (n), the
number of timesteps, a list of transitions for the flows between compartments,
and the number of simulations to run. It will return a data frame with one
column for time and a column for each state (compartment). This function makes
use of [compModels::validate_sir_stoch_input()]  for validating the
user-provided inputs to check they are of the correct type and within plausible
bounds. Output from run_sir_stochastic_tau () can be fed into
[compModels::plot_stoch_model()] to view a plot of one or more realizations of
the output using ggplot2.


```{r stochastic tau}
# nolint start
# modelout4 <- run_sir_stochastic_tau(
#   0.00001, 0.1, 1e05 - 1, 1, 0, 1e05, # parameters, initial values,
#   100, # number of timesteps
#   list(c(s = -1, i = 1), c(i = -1, r = 1)), # transitions (as a list)
#   10 # number of simulations
# )
# nolint end

modelout4 <- run_sir_stochastic_tau(
  config$stochastic_tau$beta, config$stochastic_tau$gamma,
  config$stochastic_tau$s0, config$stochastic_tau$i0, config$stochastic_tau$r0,
  config$stochastic_tau$n_pop, # population size
  config$stochastic_tau$n_timesteps, # number of timesteps
  list(
    setNames(config$stochastic_tau$transitions[[1]], c("s", "i")),
    setNames(config$stochastic_tau$transitions[[2]], c("i", "r"))
  ),
  config$stochastic_tau$n_sims # number of simulations
)
```

```{r stochastic tau plot, fig.dim = c(6,4)}
# Plot will default to plotting "i" compartment as second argument to the
# function. Additionally, default time_var is "t" so if output variable is
# 'time', this will need to be specified. adaptivetau returns 'time'.
#  NB: will need to rename to plot other compartments or for models with other
#  names for the infected compartment (eg. i1, i2, etc).
plot_stoch_model(modelout4, time_var = "time")
```


## Generalized Compartmental Models
compModels expands this basic functionality to generalized compartmental models
in which the user defines any number (and name) of compartments and transtions.
See basic-generalized-models vignette for more information.


## Estimating the initial growth rate
compModels has some helper functions to allow the user to estimate the initial
growth rate, r, for an outbreak. The estimate for r is found by regressing the
log of the cumulative incidence on time. The helper functions
[compModels::calculate_cuminf()] and
[compModels::calculate_initial_growth_rate()] are used on an example of a
deterministic model output in a single data frame, and stochastic model output
in a list of data frames.
Note: This r can then be used to estimate R0 with the relationship R0 = V*r + 1
where V is the serial interval.
```{r estimate growth}
# Basic Deterministic SIR Model (no intervention)
calculate_initial_growth_rate(modelout, time_var = "time", i_var = "i")

# Basic Stochastic SIR Model (Gillespie Algorithm) with 10 simulations,
# no intervention
calculate_initial_growth_rate(modelout3, time_var = "t", i_var = "i")
```
