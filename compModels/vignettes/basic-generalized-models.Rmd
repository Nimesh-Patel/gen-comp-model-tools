---
title: "Basic Generalized Models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{basic-generalized-models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(compModels)
```

## Overview
compModels expands the basic functionality demonstrated in the basic-sir
vignette for determintistic and stochastic compartmental models to encompss
generalized compartmental models in which the user defines any number (and name)
of compartments and transtions.


## Generalized Deterministic Model
The [compModels::run_gen_deterministic()] function allows users to run a basic
deterministic compartmental model. The user specifies the initial values and
compartment names for each of the states, a vector of times to
run the model over, a vector of compartment names, a matrix of values for the
transmission flows between compartments, an optional intervention start and end
time and accompanying single value or modifier matrix which will be multiplied
against the transmission matrix to alter transmission as a result of the
intervention. It will return a data frame with one column for
time and a column for each state (compartment). This function makes use of the
[compModels::validate_gen_determin_input()] for validating the user-provided
inputs to check they are of the correct type and within plausible bounds.
Additionally it makes use of an internal helper functions
[compModels::is_intervention_period()], [compModels::modify_trans_mtx()], and
[compModels::calculate_change_rates()].
Output from run_gen_deterministic() can be fed into
[compModels::plot_determin_model()] to view a plot of the output using ggplot2.

Future functionality currently in pull requests in Github expand this function
to be able to handle subgroup stratifications as well as user-supplied contact
matrices.

```{r gen deterministic}
initial_vals <- c(A = 1e5 - 1, B = 1, C = 0, D = 0, E = 0)
time_seq <- seq(0, 100, length.out = 101)
compartment_nms <- c("A", "B", "C", "D", "E")
transition_mtx <- matrix(
  c(
    -0.1, 0.1, 0, 0, 0,
    0, -0.1, 0.1, 0, 0,
    0, 0, -0.1, 0.1, 0,
    0, 0, 0, -0.1, 0.1,
    0.1, 0, 0, 0, -0.1
  ),
  nrow = length(compartment_nms),
  byrow = TRUE,
  dimnames = list(compartment_nms, compartment_nms)
)
start <- 25
end <- 30
modify <- 0.5 # singluar modification value
mod_mat <- matrix( # matrix of modifications
  c(
    1, 0.5, 1, 1, 1,
    1, 0.5, 0.25, 1, 1,
    1, 1, 0.25, .1, 1,
    1, 1, 1, .1, 1,
    1, 1, 1, 1, 1
  ),
  nrow = length(compartment_nms),
  byrow = TRUE,
  dimnames = list(compartment_nms, compartment_nms)
)

modelout <- run_gen_deterministic(
  init_vals_base = initial_vals,
  times = time_seq,
  comp_names_base = compartment_nms,
  trans_matrix_base = transition_mtx,
  subgroups_list = list(),
  intervention_start_time = start,
  intervention_end_time = end,
  modifier = mod_mat
)
```

```{r gen deterministic plot, fig.dim = c(6,4)}
plot_determin_model(modelout)
```

The user can also layer on stratifications to the model. Here is an example
with stratifications and no intervention.
```{r gen determin stratify, fig.dim = c(7.5,14)}
init_vals_base <- c(s = 99000, e = 0, i = 10000, r = 0)
comp_names_base <- c("s", "e", "i", "r")
beta <- .9 # transmission
sigma <- .1 # progression E->I
gamma <- 0.05 # recovery
trans_matrix_base <- matrix(
  c(
    -beta, 0, 0, 0,
    beta, -sigma, 0, 0,
    0, sigma, -gamma, 0,
    0, 0, gamma, 0
  ),
  nrow = length(comp_names_base), byrow = TRUE,
  dimnames = list(comp_names_base, comp_names_base)
)
times <- seq(0, 100, by = 1)
age_grps_vector <- c("child", "adult", "elderly")
vacc_status_vector <- c("vaccinated", "unvaccinated")
gender_cat_vector <- c("male", "female")
# Modification options
single_modifier_value <- 1
base_size_modifier_mtx <- matrix(single_modifier_value,
  nrow = length(comp_names_base),
  ncol = length(comp_names_base),
  dimnames = list(
    comp_names_base,
    comp_names_base
  )
)
get_time_dep_modifier <- function(time, subgroup_combinations) {
  num_subgroups <- nrow(subgroup_combinations)
  size <- num_subgroups * length(comp_names_base)
  if (time < 30) {
    modifier_value <- 0.8
  } else {
    modifier_value <- 0.5
  }
  matrix(modifier_value, nrow = size, ncol = size)
}

modelout2 <- run_gen_deterministic(
  init_vals_base = init_vals_base,
  times = times,
  comp_names_base = comp_names_base,
  trans_matrix_base = trans_matrix_base,
  subgroups_list =
    list(
      age_groups = age_grps_vector,
      vaccination_statuses = vacc_status_vector,
      gender_categories = gender_cat_vector
    ),
  intervention_start_time = 20,
  intervention_end_time = 40,
  modifier = get_time_dep_modifier
)
# Plot using vector of values in the stratify_by argument
plot_determin_model(modelout2, stratify_by = age_grps_vector)

modelout3 <- run_gen_deterministic(
  init_vals_base = init_vals_base,
  times = times,
  comp_names_base = comp_names_base,
  trans_matrix_base = trans_matrix_base,
  subgroups_list =
    list(
      age_groups = age_grps_vector,
      vaccination_statuses = vacc_status_vector,
      gender_categories = gender_cat_vector
    ),
  intervention_start_time = NULL,
  intervention_end_time = NULL,
  modifier = NULL
)
# Plot using values in the stratify_by argument
plot_determin_model(modelout3, stratify_by = c("child", "adult", "elderly"))
```

## Generalized Stochastic Model
### Gillespie Algorithm
The [compModels::run_gen_stochastic()] function allows users to run a basic
stochastic susceptible-infected-recovered (SIR) compartmental model using the
Gillespie Algorithm in [GillespieSSA::ssa.d]. The user specifies values for
parameters defining compartment flows, propensity functions that include the
equations for the flows between compartments, initial values for each of the
states, the number of timesteps, a change matrix of the transition information
between compartments, and the number of simulations to run. It will return a
data frame with one column for time and a column for each state (compartment).
Output from run_gen_stochastic() can be fed into
[compModels::plot_stoch_model()] to view a plot of one or more realizations of
the output using ggplot2.

Future functionality will expand this function to handle interventions
(currently in PR), to be able to handle subgroup stratifications and or
user-supplied contact matrices. Additionally it will be modified to use of
[compModels::validate_sir_stoch_input()] for validating the user-provided inputs
to check they are of the correct type and within plausible bounds.

```{r gen stochastic gillespie}
init_vals <- c(s = 990, e = 100, i1 = 10, i2 = 0, r = 0)
# nolint start
change_matrix <- matrix(
  c(
    -1, 0, 0, 0, # s -> e
    +1, -1, 0, 0, # e -> i1
    0, +1, -1, 0, # i1 -> i2
    0, 0, +1, -1, # i2 -> r
    0, 0, 0, +1
  ), # nolint end
  nrow = length(init_vals),
  byrow = TRUE,
  dimnames = list(names(init_vals), NULL)
)

modelout4 <- run_gen_stochastic(
  parms_vec = c(
    beta = 0.001, sigma = 0.1,
    alpha = 0.05, gamma = 0.1
  ),
  propensity_fns = c(
    "beta * s * i1",
    "sigma * e",
    "alpha * i1",
    "gamma * i2"
  ),
  init_vals = c(
    s = 990, e = 100,
    i1 = 10, i2 = 0, r = 0
  ),
  n_timesteps = 100,
  change_matrix = change_matrix,
  n_sims = 10
)
```

```{r gen stochastic gillespie plot, fig.dim = c(6,4)}
# Plot will default to plotting "i" compartment as second argument to the
# function. NB: will need to rename to plot other compartments or for models
# with other names for the infected compartmernt (eg. i1, i2, etc).
plot_stoch_model(modelout4, compartment = "i1")
```
